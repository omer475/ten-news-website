name: Generate Daily News
on:
  schedule:
    # Run at 7 AM UK time year-round
    # During BST (British Summer Time): UK is UTC+1, so 7 AM UK = 6 AM UTC
    # During GMT (Greenwich Mean Time): UK is UTC+0, so 7 AM UK = 7 AM UTC
    # We run at both times and let the script check if it's actually 7 AM UK time
    - cron: '0 6 * * *'  # 6 AM UTC (7 AM UK during BST - Mar to Oct)
    - cron: '0 7 * * *'  # 7 AM UTC (7 AM UK during GMT - Oct to Mar)
  workflow_dispatch:  # Manual trigger

jobs:
  generate-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # fetch full history to allow rebase before push
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Python dependencies
        run: |
          pip install requests beautifulsoup4 pytz schedule
          
      - name: Generate daily news
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          python -c "
          import sys
          import subprocess
          import datetime
          import pytz
          import os
          from pathlib import Path
          
          # Check if this is a manual run
          event = os.getenv('GITHUB_EVENT_NAME')
          is_manual = (event == 'workflow_dispatch')
          
          # Get current UK time
          uk_tz = pytz.timezone('Europe/London')
          now_uk = datetime.datetime.now(uk_tz)
          
          print('=' * 60)
          print('üöÄ TEN NEWS - GitHub Actions Runner')
          print('=' * 60)
          print(f'üìÖ Current UK time: {now_uk.strftime(\"%Y-%m-%d %H:%M:%S %Z\")}')
          print(f'üéØ Target time: 07:00 UK time')
          print(f'üîß Run type: {\"Manual\" if is_manual else \"Scheduled\"}')
          print('=' * 60)
          
          # For scheduled runs, check if it's actually 7 AM UK time
          if not is_manual:
              # Check if we're within a reasonable window of 7 AM UK time
              # This handles GitHub Actions delays and clock differences
              hour_diff = abs(now_uk.hour - 7)
              minute_window = now_uk.minute if now_uk.hour == 7 else 60
              
              if now_uk.hour == 7 and now_uk.minute < 30:
                  # We're in the 7:00-7:30 window
                  print('‚úÖ Current time is within 7:00-7:30 UK time window')
              elif now_uk.hour == 6 and now_uk.minute >= 50:
                  # Allow slight early runs (6:50-6:59)
                  print('‚úÖ Current time is close to 7:00 UK time (early window)')
              else:
                  print(f'‚è≠Ô∏è Skipping: Not 7 AM UK time (current hour: {now_uk.hour}:{now_uk.minute:02d})')
                  print('   Schedule runs only execute at 7 AM UK time')
                  sys.exit(0)
              
              # Check if we already ran today
              today_filename = now_uk.strftime('tennews_data_%Y_%m_%d.json')
              if Path(today_filename).exists():
                  print(f'‚è≠Ô∏è Skipping: {today_filename} already exists')
                  print('   News has already been generated today')
                  sys.exit(0)
          else:
              print('‚úÖ Manual run - bypassing time checks')
          
          print('\\nü§ñ Starting news generation...')
          print('-' * 60)
          
          # Run the news generator
          result = subprocess.run([sys.executable, 'news-generator.py'], 
                                input='1\\n', text=True, capture_output=True)
          
          print(result.stdout)
          if result.stderr:
              print('STDERR:', result.stderr)
          
          if result.returncode == 0:
              print('-' * 60)
              print('‚úÖ News generation completed successfully!')
              sys.exit(0)
          else:
              print('-' * 60)
              print('‚ùå News generation failed!')
              sys.exit(1)
          "
          
      - name: Commit and push generated news
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # Make sure we are up to date before committing/pushing
          git fetch origin main
          git pull --rebase origin main || true
          
          # Add generated JSON files and historical events
          git add tennews_data_*.json historical_events_*.json
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üóûÔ∏è Daily news update $(date +'%Y-%m-%d %H:%M UTC')"
            git push origin HEAD:main
          fi
